<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="query-post">
  <template>
   <iron-ajax
    method="post"
    id="querypostid"
    url="{{queryposturl}}"
    params="{{querypostparam}}"
    handle-as="json"
    content-type="application/json"
    on-response="querypostResponse"
    debounce-duration="300"
  ></iron-ajax>
  <iron-ajax
    method="post"
    id="sequenceid"
    url="{{sequenceurl}}"
    params="{{sequenceparam}}"
    handle-as="json"
    content-type="application/json"
    on-response="sequenceResponse"
    debounce-duration="300"
  ></iron-ajax>
  <iron-ajax
    method="post"
    id="upseqid"
    url="{{upsequrl}}"
    params="{{upseqparam}}"
    handle-as="json"
    content-type="application/json"
    on-response="upseqResponse"
    debounce-duration="300"
  ></iron-ajax>
  <iron-ajax
    method="post"
    id="getmsgid"
    url="{{getmsgurl}}"
    params="{{getmsgparam}}"
    handle-as="json"
    content-type="application/json"
    on-response="getmsgResponse"
    debounce-duration="300"
  ></iron-ajax>
  <iron-ajax
    method="post"
    id="queryreplyid"
    url="{{queryreplyurl}}"
    params="{{queryreplyparam}}"
    handle-as="json"
    content-type="application/json"
    on-response="queryreplyResponse"
    debounce-duration="300"
  ></iron-ajax>
   <iron-ajax
    method="post"
    id="parentinboxid"
    url="{{parentinboxurl}}"
    params="{{parentinboxparam}}"
    handle-as="json"
    content-type="application/json"
    on-response="parentinboxResponse"
    debounce-duration="300"
  ></iron-ajax>

    <style>
      :host {
        display: block;
      }
    </style>
    <div></div>
  </template>
  <script>
  (function() {
    'use strict';
    var stud_id;
    var sname;
    var semail;
    var scat;
    var scomplaint;

    Polymer({
      is: 'query-post',
      ready:function(){

      },
      querypostFn:function(student_id,name,email,category,complaint){
        //alert('hai');
        stud_id=student_id;
        sname=name;
        semail=email;
        scat=category;
        scomplaint=complaint;
       var obj={"school_id":""};
       obj.school_id='SCH001';
       this.sequenceurl="http://localhost:8082/query-sequence";
       this.sequenceparam=obj;
       this.$.sequenceid.generateRequest();
            },

sequenceResponse:function(e){
  var d1=new Date();
  var datex=d1.getDate()+'/'+(d1.getMonth()+1)+'/'+d1.getFullYear();
  var h =  d1.getHours(), m = d1.getMinutes();
    var thistime = (h > 12) ? (h-12 + ':' + m +' PM') : (h + ':' + m +' AM');
  //alert(JSON.stringify(e.detail.response.returnval));
  var seq=e.detail.response.returnval[0].sequenceno;
  var obj={"student_id":"","date":"","time":"","name":"","email":"","category":"","complaint":"","queryid":""};
        obj.school_id=sessionStorage.getItem("schoolx");;
        obj.query_id='REQ1600'+seq;
        obj.student_id=stud_id;
        obj.name=sname;
        obj.email=semail;
        obj.category=scat;
        obj.complaint=scomplaint;
        obj.date=datex;
        obj.time=thistime;
        obj.status="open";
        this.queryposturl="http://localhost:8082/query-post1";
        this.querypostparam=obj;
       // alert(JSON.stringify(obj));
       this.$.querypostid.generateRequest()
       var obj1={"school_id":"","sequence":""}
       obj1.school_id=sessionStorage.getItem("schoolx");
       obj1.sequence=parseInt(seq)+1;
       this.upsequrl="http://localhost:8082/upquery-sequence";
       this.upseqparam=obj1;
       this.$.upseqid.generateRequest();

},
querypostResponse:function(e)
{
  var s=e.detail.response.returnval;
  if(s=='success'){
  alert("Feedback submited successfuly");  
  }
  else{
    alert("Feedback not submited");
  }
  

},
getmsg:function()
{

  this.getmsgurl="http://localhost:8082/getmsg";
  var obj={"schol":"","status":""}
  obj.schol=sessionStorage.getItem("schoolx");
  obj.status="open";
  this.getmsgparam=obj;
  //alert(JSON.stringify(obj));
  this.$.getmsgid.generateRequest();
},
getmsgResponse:function(e)
{
  var msgarr=e.detail.response.returnval;
  document.querySelector('parent-inbox').msgarr=msgarr;
  //alert(JSON.stringify(msgarr));
},
postreply:function(queryid,reply){
   var d1=new Date();
  var datex=d1.getDate()+'/'+(d1.getMonth()+1)+'/'+d1.getFullYear();
  var h =  d1.getHours(), m = d1.getMinutes();
    var thistime = (h > 12) ? (h-12 + ':' + m +' PM') : (h + ':' + m +' AM');
  this.queryposturl="http://localhost:8082/querypost";
  var obj={"id":"","msg":"","schol":"","replydate":"","replytime":""}
  obj.id=queryid;
  obj.msg=reply;
  obj.replydate=datex;
  obj.replytime=thistime;
  obj.schol=sessionStorage.getItem("schoolx");
  this.querypostparam=obj;
  this.$.querypostid.generateRequest();
},
querypostResponse:function(e){
    var res=e.detail.response.returnval;
    if(res=='success'){
      alert("The reply is posted successfully");
    }
},
parentinbox:function(){
        //alert('1');
this.parentinboxurl="http://localhost:8082/parentinbox";
var obj={"id":"","schol":""}
obj.id=sessionStorage.getItem("studid");
obj.schol=sessionStorage.getItem("schoolx");
this.parentinboxparam=obj;
this.$.parentinboxid.generateRequest();
},
parentinboxResponse:function(e){
  //alert('2');
  var resarr=e.detail.response.returnval;
  document.querySelector('parentinbox-itemcard').msgarr=resarr;
//alert(JSON.stringify(resarr));
}
     

    });
  })();
  </script>
</dom-module>
