<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<dom-module id="transportfee-service">
  <template>
    <iron-ajax
        method="post"
        id="generatefeeajax"
        url="{{generatefeeurl}}"
        params="{{generatefeeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="generatefeeResponse"
        debounce-duration="300"
        >
  </iron-ajax>

   <iron-ajax
        method="post"
        id="getnameofstuajax"
        url="{{getnameofstuurl}}"
        handle-as="json"
        content-type="application/json"
        on-response="getnameofstuResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <iron-ajax
        method="post"
        id="payfeeajax"
        url="{{payfeeurl}}"
         params="{{payfeeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="payfeeResponse"
        debounce-duration="300"
        >
  </iron-ajax>
   <iron-ajax
        method="post"
        id="chequedetailsajax"
        url="{{chequedetailsurl}}"
         params="{{chequedetailsparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="chequedetailsResponse"
        debounce-duration="300"
        >
  </iron-ajax>

   <iron-ajax
        method="post"
        id="payfee2ajax"
        url="{{payfee2url}}"
         params="{{payfee2param}}"
        handle-as="json"
        content-type="application/json"
        on-response="payfee2Response"
        debounce-duration="300"
        >
  </iron-ajax>
   <iron-ajax
        method="post"
        id="chequedetails2ajax"
        url="{{chequedetails2url}}"
         params="{{chequedetails2param}}"
        handle-as="json"
        content-type="application/json"
        on-response="chequedetails2Response"
        debounce-duration="300"
        >
  </iron-ajax>
    <iron-ajax
        method="post"
        id="getfeedataajax"
        url="{{getfeedataurl}}"
         params="{{getfeedataparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getfeedataResponse"
        debounce-duration="300"
        >
  </iron-ajax>
   <iron-ajax
        method="post"
        id="getfeezoneajax"
        url="{{getfeezoneurl}}"
         params="{{getfeezoneparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getfeezoneResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <iron-ajax
        method="post"
        id="getfeenameajax"
        url="{{getfeenameurl}}"
         params="{{getfeenameparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getfeenameResponse"
        debounce-duration="300"
        >
  </iron-ajax>
   <iron-ajax
        method="post"
        id="sendrequestajax"
        url="{{sendrequesturl}}"
         params="{{sendrequestparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="sendrequestResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <iron-ajax
        
        id="getinstalltypeajax"
        url="{{getinstalltypeurl}}"
        handle-as="json"
        content-type="application/json"
        on-response="getinstalltypeResponse"
        debounce-duration="300"
        >
  </iron-ajax>
    </template>

     <script>
  (function() {
  
    var zonename;
    var stuid;
    var feez="";
    var fromd;
    var tod;
    var studname;
    var feepercent;
    var install1fee;
    var install2fee;
    var install1date;
    var install2date;
    var discountfee;
    var feestudid;
    var mode1;
    var mode2;

    Polymer({
      is: "transportfee-service",
        generatefee:function(studid)
     {
      
      this.generatefeeurl="http://localhost:8081/reportfee-card";
        var obj={"studid":""}
        obj.studid=studid;
        this.generatefeeparam=obj;
        this.$.generatefeeajax.generateRequest();
     },
     generatefeeResponse:function(e)
     {
      var date1;
      var date2;
      //alert(JSON.stringify(e.detail.response.returnval));
      feestudid=e.detail.response.returnval[0].student_id;
      discountfee=e.detail.response.returnval[0].discount_fee;
      feepercent=e.detail.response.returnval[0].fees;
      mode1=e.detail.response.returnval[0].modeofpayment1;
      mode2=e.detail.response.returnval[0].modeofpayment2;
      install1fee=e.detail.response.returnval[0].installment_1;
      install2fee=e.detail.response.returnval[0].installment_2;
      var d1=e.detail.response.returnval[0].installment_1Date;
      date1=new Date(d1);
  install1date=date1.getFullYear()+"/"+(date1.getMonth()+1)+"/"+date1.getDate();
      var d2=e.detail.response.returnval[0].installment_2Date;
      date2=new Date(d2);
     install2date=date2.getFullYear()+"/"+(date2.getMonth()+1)+"/"+date2.getDate();
      alert(feepercent);
      var feeresult=e.detail.response.returnval;
       document.querySelector('transportfee-card').feearr=feeresult;
       document.querySelector('transportfee-service').getinstalltype();
     },
     getnameofstu:function()
     {
      //alert('hi');
      this.getnameofstuurl="http://localhost:8081/getnameofstu-card";
       this.$.getnameofstuajax.generateRequest();
     },
     getnameofstuResponse:function(e)
     {

      var nameitem=e.detail.response.returnval;
      
      document.querySelector('transportfee-card').autocompletename(nameitem);
     },
     payfee:function(install,studid,paytype)
     {
      
       this.payfeeurl="http://localhost:8081/payfee-card";
        var obj={"studid":"","installfee":"","paytype":""}
        obj.studid=studid;
        obj.installfee=install;
        obj.paytype=paytype;
        this.payfeeparam=obj;
        this.$.payfeeajax.generateRequest();
     },
     payfeeResponse:function(e)
     {
        var pay1success=e.detail.response.returnval;
        //alert(JSON.stringify(pay1success));
        if(pay1success=='success')
        {
            alert("pay the fee successfully");
        }
        
     },
     chequeinfo:function(stdid,name,chequenum,bankname,chequedate)
     {
      this.chequedetailsurl="http://localhost:8081/chequedetails";
        var obj={"studid":"","name":"","chequenum":"","bankname":"","chequedate":""}
        obj.studid=stdid;
        obj.name=name;
        obj.chequenum=chequenum;
        obj.bankname=bankname;
        obj.chequedate=chequedate;
        this.chequedetailsparam=obj;
        this.$.chequedetailsajax.generateRequest();

     },
     payfee2:function(install,studid,paytype)
     {
      
       this.payfee2url="http://localhost:8081/payfee2-card";
        var obj={"studid":"","installfee":"","paytype":""}
        obj.studid=studid;
        obj.installfee=install;
        obj.paytype=paytype;
        this.payfee2param=obj;
        this.$.payfee2ajax.generateRequest();
     },
     payfee2Response:function(e)
     {
        var pay2success=e.detail.response.returnval;
       // alert(JSON.stringify(pay2success));
        if(pay2success=='success')
        {
            alert("pay the fee successfully");
        }
        
     },
     chequeinfo2:function(stdid,name,chequenum,bankname,chequedate)
     {
      this.chequedetails2url="http://localhost:8081/chequedetails2";
        var obj={"studid":"","name":"","chequenum":"","bankname":"","chequedate":""}
        obj.studid=stdid;
        obj.name=name;
        obj.chequenum=chequenum;
        obj.bankname=bankname;
        obj.chequedate=chequedate;
        this.chequedetails2param=obj;
        this.$.chequedetails2ajax.generateRequest();

     },
     getfeedata:function(id)
     {
       this.getfeedataurl="http://localhost:8081/getfeedata";
        var obj={"studid":""}
        obj.studid=id;
        this.getfeedataparam=obj;
        this.$.getfeedataajax.generateRequest(); 
     },
     getfeedataResponse:function(e){
        stuid=e.detail.response.returnval[0].student_id;
        var zonid=e.detail.response.returnval[0].zone_id,
        feez=e.detail.response.returnval[0].fees;
        document.querySelector('discountstudent-card').fees=feez;
        var fromdzxc=e.detail.response.returnval[0].from_date;
        var todzxc=e.detail.response.returnval[0].to_date;
        fromd=new Date(fromdzxc);
        tod=new Date(todzxc);
        
        
        this.getfeezoneurl="http://localhost:8081/getfeezone";
        var obj={"zone":""}
        obj.zone=zonid;
        this.getfeezoneparam=obj;
        this.$.getfeezoneajax.generateRequest(); 

       //document.querySelector('transportfee-card').feearr=feeresult;
     },
     getfeezoneResponse:function(e){
        zonenam=e.detail.response.returnval[0].zone_name;

        this.getfeenameurl="http://localhost:8081/getfeename";
        var obj={"sid":""}
        obj.sid=stuid;
        this.getfeenameparam=obj;
        this.$.getfeenameajax.generateRequest(); 
     },
     getfeenameResponse:function(e){

        var studnam=e.detail.response.returnval[0].student_name;
        var schooltyp=e.detail.response.returnval[0].school_type; 

         var fromdatz=fromd.getFullYear()+"/"+(fromd.getMonth()+1)+"/"+fromd.getDate();
        var todatz=tod.getFullYear()+"/"+(tod.getMonth()+1)+"/"+tod.getDate();
            
        document.querySelector('discountstudent-card').studname=studnam;
        document.querySelector('discountstudent-card').zonename=zonenam;
        document.querySelector('discountstudent-card').schooltype=schooltyp;
        
        document.querySelector('discountstudent-card').fromdate=fromdatz;
        document.querySelector('discountstudent-card').todate=todatz;

     },
     sendrequest:function(id,stuname,schooltypez,zonname,feesz,fromdatez,todatez,schooltypez,disamtz,reason){
        var toda=new Date();
        var fromdat=new Date(fromdatez);
         var todat =new Date(todatez);
        var fromdatey=fromdat.getFullYear()+"/"+(fromdat.getMonth()+1)+"/"+fromdat.getDate();
        var todatey=todat.getFullYear()+"/"+(todat.getMonth()+1)+"/"+todat.getDate();
        var today=toda.getFullYear()+"/"+(toda.getMonth()+1)+"/"+toda.getDate();
       this.sendrequesturl="http://localhost:8081/sendrequest";
        var obj={"stid":"","stname":"","schooltypezx":"","zoname":"","feesx":"","fromdatx":"","todatx":"","schooltypex":"","disamtx":"","reasonx":"","todayx":""}
        obj.stid=id;
        obj.stname=stuname;
        obj.schooltypezx=schooltypez;
        obj.zoname=zonname;
        obj.feesx=feesz;
        obj.fromdatx=fromdatey;
        obj.todatx=todatey;
        obj.schooltypex=schooltypez;
        obj.disamtx=disamtz;
        obj.reasonx=reason;
        obj.todayx=today;
        this.sendrequestparam=obj;
        this.$.sendrequestajax.generateRequest();  
     },
     sendrequestResponse:function(e){
        var result=e.detail.response.returnval;
        if(result=='success')
        {
            alert('Request sent');
        }
        else
        {
            alert('Request failed');
        }
     },
     getinstalltype:function()
     {
        this.getinstalltypeurl="../../configfile/installmenttype.json";
        this.$.getinstalltypeajax.generateRequest(); 
     },
     getinstalltypeResponse:function(e)
     {
        var installarr=[];
        var installdata=e.detail.response;
        for(var i=0;i<installdata.length;i++)
        {
             var paidstatus;
             var paiddate;
             var paymode;
            //alert(feepercent);
            //alert(installdata[i].amt_percentage);
            if(installdata[i].install_type=="installment1")
            {
                if(install1fee>0)
                {
                 paidstatus=true;
                 paiddate=install1date;
                 paymode=mode1;

                }
                else
                {
                    paidstatus=false;
                 paiddate="no";
                 paymode="";
                }
            }
             if(installdata[i].install_type=="installment2")
            {
                if(install2fee>0)
                {
                 paidstatus=true;
                 paiddate=install2date;
                 paymode=mode2;

                }
                else
                {
                    paidstatus=false;
                 paiddate="no";
                 paymode="";
                }
            }
            var obj={"installtype":"","amount":"","paydate":"","paidstatus":"","installdate":"","paymentmode":"","studid":""}
            obj.installtype=installdata[i].install_type;
            obj.amount=((parseInt(feepercent)-parseInt(discountfee))/100)*parseInt(installdata[i].amt_percentage);
            obj.paydate=installdata[i].paydate;
            obj.installdate=paiddate;
            obj.paidstatus=paidstatus;
            obj.paymentmode=paymode;
            obj.studid=feestudid;
            installarr.push(obj);
        }
        alert(JSON.stringify(installarr));
//alert(JSON.stringify(e.detail.response));
document.querySelector('transportfee-card').installmentarr=installarr;
     }

    });
 })();
  </script>

</dom-module>


     
